<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Page</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    .product-card { 
      margin-bottom: 20px; 
    }
    .product-card img { 
      max-width: 100%; 
      height: auto; 
    }

    .card {
      transition: box-shadow 0.3s ease;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,.125);
      position: relative;
    }
    .card:hover {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.1);
      opacity: 0;
      transition: opacity 0.2s ease;
      pointer-events: none;
    }
    .card:hover::after {
      opacity: 1;
    }
  </style>
</head>
<body class="container py-4">
  <h2 class="mb-4">Pilih Produk</h2>
  <div class="row">
    <div class="col-md-8">
      <div class="mb-4">
        <label for="filter-category" class="form-label">Filter Kategori</label>
        <select class="form-select" id="filter-category" onchange="filterProducts()">
          <option value="all">Semua</option>
          <option value="dompet">dompet</option>
          <option value="tas">tas</option>
          <option value="jaket">jaket</option> 
        </select>
      </div>
      <div class="row" id="product-list"></div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h5 class="card-title">Keranjang</h5>
          <ul class="list-group mb-3" id="cart-items"></ul>
          <h6>Total: <span id="cart-total">Rp 0</span></h6>
          <button class="btn btn-primary w-100" onclick="checkout()">Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTVLdykdjAbNzREUgHX549VEg6emNlw0rMzqjhz5dkc-XQtrejEYbhOvlLnIA8MzSDLSP0F7ZWaWsF-/pub?gid=0&single=true&output=csv";
    const webAppURL = "https://script.google.com/macros/s/AKfycbyb-DY-7WJjA0p7PuJmucSInU_vPS9x6ZDDWTHB3VdaRJCsXTpItKy7xBcEC8jNENMd/exec";

    let cart = [];
    let allProducts = [];
    let productIndex = 0; // Used to create unique identifiers for products

    function renderCart() {
      const cartList = document.getElementById("cart-items");
      const totalDisplay = document.getElementById("cart-total");
      cartList.innerHTML = "";

      let total = 0;
      cart.forEach((item, index) => {
        const itemTotal = item.harga * item.qty;
        total += itemTotal;

        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
          <div>
            <strong>${item.nama}</strong><br>
            <small>${item.qty} x Rp ${item.harga.toLocaleString()}</small>
            <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeFromCart(${index})">-</button>
          </div>
          <span>Rp ${itemTotal.toLocaleString()}</span>
        `;
        cartList.appendChild(li);
      });

      totalDisplay.textContent = "Rp " + total.toLocaleString();
    }

    function addToCart(productId) {
      // Find the product in allProducts array
      const product = allProducts.find(p => p.id === productId);
      if (!product) return;
      
      const existing = cart.find(item => item.id === productId);
      if (existing) {
        existing.qty++;
      } else {
        cart.push({ 
          id: product.id,
          nama: product.nama,
          harga: product.harga,
          qty: 1 
        });
      }
      renderCart();
    }

    function removeFromCart(index) {
      if (cart[index].qty > 1) {
        cart[index].qty--;
      } else {
        cart.splice(index, 1);
      }
      renderCart();
    }

    function checkout() {
      if (cart.length === 0) {
        alert("Keranjang kosong!");
        return;
      }

      const payload = JSON.stringify({
        order: cart.map(item => ({
          nama: item.nama,
          harga: item.harga,
          qty: item.qty
        }))
      });

      const checkoutBtn = document.querySelector('button[onclick="checkout()"]');
      const originalText = checkoutBtn.textContent;
      checkoutBtn.disabled = true;
      checkoutBtn.textContent = "Processing...";

      fetch(webAppURL, {
        method: "POST",
        headers: {
          'Content-Type': 'text/plain' 
        },
        body: payload
      })
      .then(response => {
        checkoutBtn.disabled = false;
        checkoutBtn.textContent = originalText;
        alert("Pesanan berhasil dikirim!");
        cart = [];
        renderCart();
        loadProducts(); 
      })
      .catch(err => {
        checkoutBtn.disabled = false;
        checkoutBtn.textContent = originalText;
        alert("Gagal mengirim pesanan: " + err.message);
        console.error("Fetch error:", err);
      });
    }

    // Improved CSV parsing function to handle your specific data format
    function parseCSVRow(row) {
      const result = [];
      let startIdx = 0;
      let inQuotes = false;
      
      for (let i = 0; i < row.length; i++) {
        if (row[i] === '"') {
          inQuotes = !inQuotes;
        } 
        else if ((row[i] === ',' && !inQuotes) || i === row.length - 1) {
          let endIdx = i === row.length - 1 ? i + 1 : i;
          let field = row.substring(startIdx, endIdx);
          
          if (field.startsWith('"') && field.endsWith('"')) {
            field = field.substring(1, field.length - 1);
          }
          
          result.push(field);
          startIdx = i + 1;
        }
      }
      
      return result;
    }

    // Extract numeric price from various formats (e.g., "150000 p")
    function extractPrice(priceString) {
      // Extract only the numeric part
      const numericMatch = priceString.match(/\d+/);
      if (numericMatch) {
        return parseInt(numericMatch[0], 10);
      }
      return 0;
    }

    function loadProducts() {
      fetch(sheetURL)
        .then(res => res.text())
        .then(data => {
          const rows = data.trim().split("\n").slice(1); // Skip header row
          const productList = document.getElementById("product-list");
          productList.innerHTML = "";
          allProducts = [];
          productIndex = 0;

          rows.forEach(row => {
            const fields = parseCSVRow(row);
            if (fields.length < 6) return; // We need at least 6 fields based on your table
            
            const nama = fields[0].trim();
            const gambar = fields[1].trim();
            const stok = parseInt(fields[2], 10);
            const hargaRaw = fields[3].trim();
            const deskripsi = fields[4].trim();  
            const kategori = fields[5].trim();
            
            // Extract numeric price from the price field
            const harga = extractPrice(hargaRaw);
            
            if (isNaN(stok) || stok <= 0) return; // Skip out of stock items
            
            // Assign a unique ID to each product
            const productId = ++productIndex;
            
            // Store product in global array
            allProducts.push({ 
              id: productId,
              nama, 
              gambar, 
              stok, 
              harga, 
              deskripsi, 
              kategori 
            });
            
            const col = document.createElement("div");
            col.className = "col-md-4 mb-4 product-card";
            col.setAttribute("data-category", kategori);
            col.innerHTML = `
              <div class="card h-100">
                <img src="${gambar}" class="card-img-top" alt="${nama}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                <div class="card-body text-center">
                  <h5 class="card-title">${nama}</h5>
                  <p class="card-text">Rp ${harga.toLocaleString()}</p>
                  <p class="card-text"><small class="text-muted">${deskripsi || ''}</small></p>
                  <p class="card-text"><small class="text-muted">Kategori: ${kategori}</small></p>
                  <button class="btn btn-sm btn-outline-success" onclick="addToCart(${productId})">+</button>
                </div>
              </div>
            `;
            productList.appendChild(col);
          });
          
          filterProducts();
        })
        .catch(error => {
          console.error("Error loading products:", error);
          document.getElementById("product-list").innerHTML = 
            `<div class="col-12 text-center text-danger">
              <p>Gagal memuat produk. Silakan coba lagi nanti.</p>
            </div>`;
        });
    }

    function filterProducts() {
      const selectedCategory = document.getElementById("filter-category").value;
      const productCards = document.querySelectorAll(".product-card");
      
      productCards.forEach(card => {
        const category = card.getAttribute("data-category");
        
        if (selectedCategory === "all" || category === selectedCategory) {
          card.style.display = "block";
        } else {
          card.style.display = "none";
        }
      });
    }

    window.addEventListener('DOMContentLoaded', loadProducts);
  </script>
</body>
</html>